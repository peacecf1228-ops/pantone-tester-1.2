<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>PANTONE 色號辨識</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #111827;
      --card: #020617;
      --border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --shadow-subtle: 0 10px 30px rgba(15, 23, 42, 0.7);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Microsoft JhengHei", sans-serif;
      --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top left, #1e293b, #020617 55%)
        fixed;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      background: linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.98)
      );
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.12);
      padding: 24px 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      backdrop-filter: blur(14px);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #e0f2fe;
      border: 1px solid rgba(56, 189, 248, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-pill {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.12);
      border: 1px solid rgba(45, 212, 191, 0.3);
      color: #a7f3d0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.18);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.8fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      body {
        padding: 16px;
      }
      .app {
        padding: 18px 16px 16px;
      }
      main {
        display: flex;
        flex-direction: column;
      }
    }

    .card {
      background: radial-gradient(circle at top, #020617, #020617 62%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-subtle);
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -60px;
      background: radial-gradient(
        circle at top right,
        rgba(56, 189, 248, 0.07),
        transparent 60%
      );
      opacity: 0.7;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
      backdrop-filter: blur(10px);
    }

    .upload-area {
      position: relative;
      margin-top: 8px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      background: linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.9),
        rgba(17, 24, 39, 0.95)
      );
      padding: 18px 16px;
      display: flex;
      gap: 14px;
      align-items: center;
      cursor: pointer;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
      z-index: 1;
    }

    .upload-area:hover {
      border-color: rgba(56, 189, 248, 0.7);
      background: radial-gradient(
        circle at top left,
        rgba(15, 118, 110, 0.12),
        rgba(15, 23, 42, 0.98)
      );
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.9);
    }

    .upload-icon {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(
        circle at 30% 20%,
        rgba(56, 189, 248, 0.7),
        rgba(8, 47, 73, 0.95)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 24px rgba(8, 47, 73, 0.9);
      flex-shrink: 0;
    }

    .upload-icon svg {
      width: 22px;
      height: 22px;
      color: #e0f2fe;
    }

    .upload-text-main {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .upload-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .upload-note {
      margin-left: auto;
      font-size: 11px;
      color: #93c5fd;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.6);
      background: rgba(15, 23, 42, 0.7);
      white-space: nowrap;
    }

    .file-input {
      display: none;
    }

    .preview-grid {
      position: relative;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 12px;
      margin-top: 8px;
      z-index: 1;
    }

    @media (max-width: 900px) {
      .preview-grid {
        grid-template-columns: 1fr;
      }
    }

    .image-frame {
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(
        circle at top,
        rgba(30, 64, 175, 0.18),
        rgba(15, 23, 42, 1)
      );
      overflow: hidden;
      min-height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-frame-inner {
      position: relative;
      width: 100%;
      height: 100%;
      max-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .image-frame img {
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
      filter: saturate(1.05) contrast(1.02);
      transition: transform var(--transition-med);
    }

    .image-placeholder {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
    }

    .image-placeholder span {
      font-family: var(--font-mono);
      font-size: 11px;
      color: #818cf8;
    }

    .swatch-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(
        circle at top left,
        rgba(56, 189, 248, 0.18),
        #020617 65%
      );
      padding: 10px 11px 11px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .swatch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .swatch-main {
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 10px;
      align-items: center;
    }

    .swatch-box {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #111827;
      width: 84px;
      height: 84px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .swatch-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .value {
      font-family: var(--font-mono);
      font-size: 12px;
    }

    .value-strong {
      font-family: var(--font-mono);
      font-size: 13px;
      color: #bfdbfe;
    }

    .accuracy-chip {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(52, 211, 153, 0.7);
      background: rgba(6, 95, 70, 0.3);
      font-size: 11px;
      color: #a7f3d0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .accuracy-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }

    .hint-text {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
      line-height: 1.4;
    }

    .hint-text strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .table-wrapper {
      position: relative;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(
        circle at top left,
        rgba(37, 99, 235, 0.25),
        #020617 68%
      );
      padding: 12px 12px 10px;
      overflow: hidden;
    }

    .best-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      background: rgba(8, 47, 73, 0.8);
      color: #e0f2fe;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .table-container {
      margin-top: 10px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.92);
      max-height: 320px;
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: linear-gradient(
        90deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.96)
      );
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th,
    td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      font-weight: 500;
      color: #9ca3af;
    }

    tbody tr {
      transition: background var(--transition-fast);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.94);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.98);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.38);
    }

    .row-best {
      background: radial-gradient(
          circle at left,
          rgba(56, 189, 248, 0.22),
          transparent 70%
        ),
        rgba(15, 23, 42, 0.98);
    }

    .row-best:hover {
      background: radial-gradient(
          circle at left,
          rgba(56, 189, 248, 0.28),
          transparent 70%
        ),
        rgba(15, 23, 42, 0.98);
    }

    .pantone-name {
      font-size: 12px;
    }

    

    .pantone-swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.6);
      vertical-align: -2px;
      margin-right: 8px;
      background: #111827;
    }
.pantone-tag {
      display: inline-flex;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      margin-left: 6px;
      color: #9ca3af;
    }

    .rgb-badge {
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .delta-e {
      font-family: var(--font-mono);
    }

    .accuracy-good {
      color: #bbf7d0;
    }

    .accuracy-mid {
      color: #fde68a;
    }

    .accuracy-low {
      color: #fecaca;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .status-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-main-strong {
      color: #e5e7eb;
    }

    .status-secondary {
      font-family: var(--font-mono);
      color: #6b7280;
    }

    small.code {
      font-family: var(--font-mono);
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 1px 6px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: #9ca3af;
    }
  
    /* --- Click-to-zoom swatch modal --- */
    .pantone-swatch {
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .pantone-swatch:hover {
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.75);
    }
    .pantone-swatch:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.35), 0 10px 22px rgba(15, 23, 42, 0.75);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.72);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal {
      width: min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.10), rgba(2, 6, 23, 0.98) 60%);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.55);
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
    }
    .modal-title {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }
    .modal-title strong {
      font-size: 13px;
      color: #e5e7eb;
      letter-spacing: 0.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .modal-title span {
      font-family: var(--font-mono);
      font-size: 11px;
      color: #9ca3af;
    }
    .modal-close {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(15, 23, 42, 0.75);
      color: #e5e7eb;
      border-radius: 999px;
      padding: 8px 10px;
      cursor: pointer;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
      line-height: 1;
    }
    .modal-close:hover {
      transform: translateY(-1px);
      border-color: rgba(56, 189, 248, 0.55);
    }
    .modal-body {
      padding: 14px;
      display: grid;
      gap: 12px;
    }
    .modal-swatch {
      width: 100%;
      height: 260px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.75);
      background: #111827;
    }
    .modal-hint {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.4;
    }

  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>
          PANTONE 色號辨識
          <span class="badge">HTML Prototype</span>
        </h1>
        <div class="subtitle">
          上傳產品圖片 → 偵測主色 → 與
          <strong> PANTONE 色號</strong> 比對，顯示 ΔE 與匹配度 / 辨識率。
        </div>
      </div>
      <div class="status-pill">
        <span class="status-dot"></span>
        前端本機運算 · 不需後端
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">圖片上傳與主色偵測</div>
            <div class="card-subtitle">
              建議使用光線均勻、背景簡單的產品側拍或正面圖。
            </div>
          </div>
          <span class="pill">sRGB · 中心區域取樣</span>
        </div>

        <label class="upload-area" id="uploadArea">
          <div class="upload-icon">
            <svg viewBox="0 0 24 24" fill="none">
              <path
                d="M12 15V5m0 0L8 9m4-4 4 4"
                stroke="currentColor"
                stroke-width="1.6"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M6 15.5v1.75A2.75 2.75 0 0 0 8.75 20h6.5A2.75 2.75 0 0 0 18 17.25V15.5"
                stroke="currentColor"
                stroke-width="1.6"
                stroke-linecap="round"
              />
            </svg>
          </div>
          <div>
            <div class="upload-text-main">點擊或拖曳圖片到此區上傳</div>
            <div class="upload-text-sub">
              支援 JPG / PNG；為了相容性，建議先將 WebP 轉成 PNG。
            </div>
          </div>
          <span class="upload-note">僅在瀏覽器本機分析，不會上傳檔案</span>
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept="image/jpeg,image/png,image/jpg,image/heic,image/heif,image/webp"
          />
        </label>

        <div class="preview-grid">
          <div class="image-frame">
            <div class="image-frame-inner">
              <img id="previewImage" alt="" style="display: none" />
              <div class="image-placeholder" id="imagePlaceholder">
                尚未載入圖片<br />
                <span>主色會從圖片中心區域自動計算</span>
              </div>
            </div>
          </div>

          <div class="swatch-card">
            <div class="swatch-header">
              <span>偵測到的主色</span>
              <span id="swatchStatus" class="label">等待上傳圖片</span>
            </div>
            <div class="swatch-main">
              <div
                class="swatch-box"
                id="swatchBox"
                style="background:#020617"
              ></div>
              <div class="swatch-meta">
                <div class="meta-row">
                  <span class="label">RGB</span>
                  <span class="value" id="rgbValue">-</span>
                </div>
                <div class="meta-row">
                  <span class="label">HEX</span>
                  <span class="value" id="hexValue">-</span>
                </div>
                <div class="meta-row">
                  <span class="label">最佳匹配</span>
                  <span class="value-strong" id="bestNameValue">-</span>
                </div>
                <div class="meta-row">
                  <span class="label">辨識率</span>
                  <span class="accuracy-chip" id="accuracyChip" style="display:none;">
                    <span class="accuracy-dot"></span>
                    <span id="accuracyValue">-</span>
                  </span>
                </div>
              </div>
            </div>
            <div class="hint-text">
              <strong>說明：</strong>ΔE 越接近 0 代表與 PANTONE 顏色越相近。此處的
              「辨識率」為依 ΔE 映射出的信心分數，僅供設計初步參考。
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">PANTONE 色號比對結果</div>
            <div class="card-subtitle">
              支援 4689 筆 Pantone C / TPG 原始色票。
            </div>
          </div>
          <span class="pill">CIE76 ΔE · 自訂匹配度模型</span>
        </div>

        <div class="table-wrapper">
          <div class="best-pill" id="bestSummary">
            尚未比對 · 請先上傳圖片
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th style="width: 40%">PANTONE 色號</th>
                  <th style="width: 26%">參考 RGB</th>
                  <th style="width: 17%">ΔE</th>
                  <th style="width: 17%">匹配度(%)</th>
                </tr>
              </thead>
              <tbody id="resultsBody">
                <!-- 動態填入比對結果 -->
              </tbody>
            </table>
          </div>
          <div class="status-bar" id="statusBar">
            <div class="status-main">
              <span class="status-main-strong" id="statusText">就緒</span>
            </div>
            <div class="status-secondary">
              ΔE 演算法：<small class="code">CIE76</small>
              · 取樣：<small class="code">中心區域 + 網格平均</small>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>


  <!-- Color preview modal -->
  <div class="modal-overlay" id="colorModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPantoneName">
      <div class="modal-header">
        <div class="modal-title">
          <strong id="modalPantoneName">-</strong>
          <span id="modalPantoneMeta">-</span>
        </div>
        <button class="modal-close" id="modalCloseBtn" type="button" aria-label="關閉">✕</button>
      </div>
      <div class="modal-body">
        <div class="modal-swatch" id="modalSwatch"></div>
        <div class="modal-hint">點擊背景或按 <small class="code">Esc</small> 可關閉。</div>
      </div>
    </div>
  </div>

  <canvas id="hiddenCanvas" style="display:none;"></canvas>

  <script>
    // -----------------------------
    // PANTONE 20 色資料庫（與 Python 版一致）
    // -----------------------------
    const PANTONE_DB = [
      // 常見 10 個高彩度色（與 Python 版一致）
      { name: "PANTONE Bright Red C", rgb: [249, 56, 34] }, // #F93822
      { name: "PANTONE 165 C", rgb: [255, 103, 31] },       // #FF671F
      { name: "PANTONE 123 C", rgb: [255, 199, 44] },       // #FFC72C
      { name: "PANTONE 348 C", rgb: [0, 132, 61] },         // #00843D
      { name: "PANTONE 299 C", rgb: [0, 163, 224] },        // #00A3E0
      { name: "PANTONE 286 C", rgb: [0, 51, 160] },         // #0033A0
      { name: "PANTONE Purple C", rgb: [78, 0, 142] },      // #4E008E
      { name: "PANTONE 185 C", rgb: [228, 0, 43] },         // #E4002B
      { name: "PANTONE 4695 C", rgb: [91, 52, 39] },        // #5B3427
      { name: "PANTONE 7543 C", rgb: [152, 164, 174] },     // #98A4AE
      // 衛浴常見 10 色
      { name: "PANTONE 7541 C", rgb: [217, 225, 226] },     // #D9E1E2
      { name: "PANTONE 427 C", rgb: [208, 211, 212] },      // #D0D3D4
      { name: "PANTONE Cool Gray 3 C", rgb: [200, 201, 199] }, // #C8C9C7
      { name: "PANTONE 468 C", rgb: [221, 203, 164] },      // #DDCBA4
      { name: "PANTONE 623 C", rgb: [155, 187, 176] },      // #9BBBB0
      { name: "PANTONE 5503 C", rgb: [153, 190, 196] },     // #99BEC4
      { name: "PANTONE 317 C", rgb: [177, 228, 227] },      // #B1E4E3
      { name: "PANTONE 2905 C", rgb: [141, 201, 232] },     // #8DC9E8
      { name: "PANTONE 320 C", rgb: [0, 156, 166] },        // #009CA6
      { name: "PANTONE 430 C", rgb: [124, 135, 142] },      // #7C878E
      // Pantone Gray(145) 群組色票
      { name: "PANTONE 6119 C", rgb: [46, 60, 65] },      // #2E3C41
      { name: "PANTONE 6189 C", rgb: [45, 61, 59] },      // #2D3D32
      { name: "PANTONE 6198 C", rgb: [201, 204, 192] },      // #C9CCC0
      { name: "PANTONE 6199 C", rgb: [189, 190, 174] },      // #BDBEAE
      { name: "PANTONE 6211 C", rgb: [141, 148, 155] },      // #8D949B
      { name: "PANTONE 6212 C", rgb: [126, 131, 137] },      // #7E8389
      { name: "PANTONE 6213 C", rgb: [114, 120, 125] },      // #72787D
      { name: "PANTONE 6214 C", rgb: [107, 112, 115] },      // #6B7073
      { name: "PANTONE 6215 C", rgb: [96, 102, 103] },      // #606667
      { name: "PANTONE 6216 C", rgb: [80, 82, 80] },      // #505250
      { name: "PANTONE 6217 C", rgb: [70, 73, 70] },      // #464946
      { name: "PANTONE 7653 C", rgb: [148, 135, 148] },      // #948794
      { name: "PANTONE 5175 C", rgb: [216, 200, 209] },      // #D8C8D1
      { name: "PANTONE 5165 C", rgb: [211, 192, 205] },      // #D3C0CD
      { name: "PANTONE 5235 C", rgb: [208, 190, 199] },      // #D0BEC7
      { name: "PANTONE 4114 C", rgb: [155, 140, 146] },      // #9B8C92
      { name: "PANTONE 4117 C", rgb: [114, 100, 119] },      // #726477
      { name: "PANTONE 4119 C", rgb: [64, 56, 69] },      // #403845
      { name: "PANTONE 7660 C", rgb: [153, 145, 164] },      // #9991A4
      { name: "PANTONE 5305 C", rgb: [198, 196, 210] },      // #C6C4D2
      { name: "PANTONE 2358 C", rgb: [173, 164, 174] },      // #ADAAAE
      { name: "PANTONE 2359 C", rgb: [127, 115, 132] },      // #7F7384
      { name: "PANTONE 2364 C", rgb: [102, 89, 108] },      // #66596C
      { name: "PANTONE 4132 C", rgb: [59, 58, 74] },      // #3B3A4A
      { name: "PANTONE 4133 C", rgb: [59, 59, 70] },      // #3B3B46
      { name: "PANTONE 4134 C", rgb: [160, 162, 176] },      // #A0A2B0
      { name: "PANTONE 4140 C", rgb: [57, 61, 71] },      // #393D47
      { name: "PANTONE 4155 C", rgb: [185, 201, 204] },      // #B9C9CC
      { name: "PANTONE 4169 C", rgb: [182, 200, 194] },      // #B6C8C2
      { name: "PANTONE 5595 C", rgb: [191, 206, 194] },      // #BFCEC2
      { name: "PANTONE 5665 C", rgb: [186, 197, 185] },      // #BAC5B9
      { name: "PANTONE 5655 C", rgb: [176, 189, 176] },      // #B0BDA0
      { name: "PANTONE 5645 C", rgb: [163, 178, 164] },      // #A3B2A4
      { name: "PANTONE 5635 C", rgb: [148, 165, 150] },      // #94A596
      { name: "PANTONE 4176 C", rgb: [196, 206, 194] },      // #C4CEC2
      { name: "PANTONE 4177 C", rgb: [187, 190, 174] },      // #BBBEAE
      { name: "PANTONE 4182 C", rgb: [106, 120, 102] },      // #6A7866
      { name: "PANTONE 4183 C", rgb: [185, 193, 180] },      // #B9C1B4
      { name: "PANTONE 4184 C", rgb: [154, 171, 158] },      // #9AAB9E
      { name: "PANTONE 5527 C", rgb: [188, 201, 197] },      // #BCC9C5
      { name: "PANTONE 5517 C", rgb: [177, 192, 188] },      // #B1C0BC
      { name: "PANTONE 5507 C", rgb: [157, 176, 172] },      // #9DB0AC
      { name: "PANTONE 4190 C", rgb: [167, 178, 163] },      // #A7B2A3
      { name: "PANTONE 4191 C", rgb: [148, 165, 158] },      // #94A59E
      // Pantone White(18) 群組（來源：pantonecolors.net）
      { name: "PANTONE 6197 C", rgb: [215, 217, 210] },      // #D7D9D2
      { name: "PANTONE 7604 C", rgb: [228, 213, 211] },      // #E4D5D3
      { name: "PANTONE 7632 C", rgb: [214, 201, 202] },      // #D6C9CA
      { name: "PANTONE 5245 C", rgb: [219, 205, 211] },      // #DBCDD3
      { name: "PANTONE 7443 C", rgb: [221, 218, 232] },      // #DDDAE8
      { name: "PANTONE 663 C", rgb: [229, 225, 230] },      // #E5E1E6
      { name: "PANTONE 664 C", rgb: [224, 219, 227] },      // #E0DBE3
      { name: "PANTONE 5315 C", rgb: [216, 215, 223] },      // #D8D7DF
      { name: "PANTONE 649 C", rgb: [219, 226, 233] },      // #DBE2E9
      { name: "PANTONE 656 C", rgb: [221, 229, 237] },      // #DDE5ED
      { name: "PANTONE 621 C", rgb: [209, 224, 215] },      // #D1E0D7
      { name: "PANTONE 2330 C", rgb: [207, 205, 201] },      // #CFCDC9
      { name: "PANTONE 1 C (D7D2CB)", rgb: [215, 210, 203] },      // #D7D2CB
      { name: "PANTONE 1 C (D9D9D6)", rgb: [217, 217, 214] },      // #D9D9D6
      { name: "PANTONE 2 C (White)", rgb: [208, 208, 206] },      // #D0D0CE
      { name: "PANTONE 4201 TCX", rgb: [240, 238, 233] },      // #F0EEE9

    ];
    // -----------------------------
    // 自動擴充：從 pantonecolors.net 下載色票（Red / Orange / Yellow / Green / Blue / Purple / Gray / Black）
    // - 使用 r.jina.ai 文字代理以避免跨網域（CORS）限制
    // - UI 不變，只增加色票資料量
    // -----------------------------
    const PANTONE_GROUPS_TO_LOAD = new Set([
      "Red","Orange","Yellow","Green","Blue","Purple","Gray","Black"
    ]);

    function hexToRgbArray(hex) {
      const h = (hex || "").trim().replace(/^#/, "");
      if (!/^[0-9a-fA-F]{6}$/.test(h)) return null;
      const r = parseInt(h.slice(0, 2), 16);
      const g = parseInt(h.slice(2, 4), 16);
      const b = parseInt(h.slice(4, 6), 16);
      return [r, g, b];
    }

    function normalizePantoneName(rawName) {
      const n = (rawName || "").trim();
      if (!n) return null;
      if (/^PANTONE\b/i.test(n)) return n.replace(/^PANTONE\s+/i, "PANTONE ");
      return "PANTONE " + n;
    }

    async function loadPantoneGroupsFromPantoneColorsNet() {
      // 正式完整色庫版（桌機 HTML）：第一次需要網路載入，之後會快取到 localStorage，可離線重開。
      const CACHE_KEY = "pantone_full_db_v2";
      const CACHE_META_KEY = "pantone_full_db_v2_meta";
      const EXPECT_GROUPS = ["Red","Orange","Yellow","Green","Blue","Purple","Gray","Black"];
      const NOW = Date.now();

      // 1) 先嘗試讀取快取（避免每次都抓網路）
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        const metaRaw = localStorage.getItem(CACHE_META_KEY);
        if (raw && metaRaw) {
          const meta = JSON.parse(metaRaw);
          // 若快取很新（30 天內）且資料量夠大，就直接使用
          if (meta && meta.count && meta.count > 1500 && meta.ts && (NOW - meta.ts) < 30 * 24 * 3600 * 1000) {
            const cached = JSON.parse(raw);
            if (Array.isArray(cached) && cached.length === meta.count) {
              return cached;
            }
          }
        }
      } catch (e) {
        // ignore cache errors
      }

      // 2) 走網路載入（多個備援端點）
      const urls = [
        "https://r.jina.ai/https://pantonecolors.net/",
        "https://r.jina.ai/http://pantonecolors.net/",
        "https://r.jina.ai/http://https://pantonecolors.net/",
        // 備援：有些環境對 https 會較嚴格，改走 www
        "https://r.jina.ai/https://www.pantonecolors.net/",
        "https://r.jina.ai/http://www.pantonecolors.net/"
      ];

      let text = null;
      let lastErr = null;

      for (const url of urls) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("Fetch failed: " + res.status);
          const t = await res.text();
          // 簡單驗證：必須包含任一群組標題
          if (t && /###\s+Pantone\s+Red\s*\(\d+\)/.test(t)) {
            text = t;
            break;
          }
        } catch (err) {
          lastErr = err;
        }
      }

      if (!text) {
        throw new Error("Unable to load pantonecolors.net via proxy. " + (lastErr ? String(lastErr) : ""));
      }

      // 解析格式（純文字）：
      // ### Pantone Red(288)
      // Red C
      // #F93822
      // 016 C
      // #FF5600
      const groupRe = /###\s+Pantone\s+(Red|Orange|Yellow|Green|Blue|Purple|Gray|Black)\s*\(\d+\)[\s\S]*?(?=(?:###\s+Pantone\s+)|$)/g;

      const entries = [];
      let match;
      while ((match = groupRe.exec(text)) !== null) {
        const group = match[1];
        if (!PANTONE_GROUPS_TO_LOAD.has(group)) continue;

        const block = match[0];
        const lines = block
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter((l) => l.length > 0);

        // lines[0] = "### Pantone XXX(###)"
        for (let i = 1; i < lines.length - 1; i++) {
          const maybeName = lines[i];
          const maybeHex = lines[i + 1];
          if (/^#([0-9a-fA-F]{6})$/.test(maybeHex)) {
            const rgb = hexToRgbArray(maybeHex);
            const name = normalizePantoneName(maybeName);
            if (rgb && name) entries.push({ name, rgb, group });
            i += 1;
          }
        }
      }

      // 3) 寫入快取
      try {
        const payload = entries.map((e) => ({ name: e.name, rgb: e.rgb }));
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
        localStorage.setItem(CACHE_META_KEY, JSON.stringify({
          ts: NOW,
          count: payload.length,
          groups: EXPECT_GROUPS
        }));
        return payload;
      } catch (e) {
        // 如果 localStorage 滿了，就直接回傳不快取
        return entries.map((e) => ({ name: e.name, rgb: e.rgb }));
      }
    }

    // 從 GitHub 讀取 Pantone TPG 色票（Margaret2/pantone-colors 專案）
    async function loadPantoneTPGFromGithub() {
      const url =
        "https://raw.githubusercontent.com/Margaret2/pantone-colors/master/pantone-colors.json";

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) {
        throw new Error("Unable to load Pantone TPG JSON: " + res.status);
      }

      const data = await res.json();
      if (!data || !Array.isArray(data.names) || !Array.isArray(data.values)) {
        throw new Error("Unexpected Pantone TPG JSON structure");
      }

      const names = data.names;
      const values = data.values;
      const len = Math.min(names.length, values.length);
      const entries = [];

      for (let i = 0; i < len; i++) {
        const rawName = (names[i] || "").trim();
        const hex = (values[i] || "").trim();
        const rgb = hexToRgbArray(hex);
        if (!rawName || !rgb) continue;

        const prettyName =
          "PANTONE " +
          rawName
            .split("-")
            .map((part) =>
              part ? part.charAt(0).toUpperCase() + part.slice(1) : part
            )
            .join(" ") +
          " TPG";

        entries.push({ name: prettyName, rgb });
      }

      return entries;
    }

    function mergePantoneEntries(newEntries) {
      // 允許同名但不同 RGB：自動加尾碼避免覆蓋
      const seen = new Set(PANTONE_DB.map((x) => `${x.name}|${x.rgb.join(",")}`));
      const nameUsed = new Set(PANTONE_DB.map((x) => x.name));
      let added = 0;

      const makeUniqueName = (base) => {
        if (!nameUsed.has(base)) return base;
        let k = 2;
        while (nameUsed.has(`${base} (${k})`)) k++;
        return `${base} (${k})`;
      };

      for (const e of newEntries) {
        const key = `${e.name}|${e.rgb.join(",")}`;
        if (seen.has(key)) continue;

        let name = e.name;
        if (nameUsed.has(name)) {
          name = makeUniqueName(name);
        }
        PANTONE_DB.push({ name, rgb: e.rgb });
        seen.add(`${name}|${e.rgb.join(",")}`);
        nameUsed.add(name);
        added += 1;
      }
      return added;
    }

    // 先占位：後面 DOM 元素 ready 後會真正開始載入
    let pantoneReadyPromise = Promise.resolve();


    // -----------------------------
    // 顏色數學：RGB -> Lab + ΔE(CIE76) + 匹配度
    // -----------------------------
    function rgbToLab(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;

      const invGamma = (t) =>
        t > 0.04045 ? Math.pow((t + 0.055) / 1.055, 2.4) : t / 12.92;

      r = invGamma(r);
      g = invGamma(g);
      b = invGamma(b);

      let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
      let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.0;
      let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

      const f = (t) =>
        t > 0.008856 ? Math.pow(t, 1 / 3) : 7.787 * t + 16 / 116;

      x = f(x);
      y = f(y);
      z = f(z);

      const L = 116 * y - 16;
      const a = 500 * (x - y);
      const bVal = 200 * (y - z);
      return [L, a, bVal];
    }

    function deltaE76(lab1, lab2) {
      const dL = lab1[0] - lab2[0];
      const da = lab1[1] - lab2[1];
      const db = lab1[2] - lab2[2];
      return Math.sqrt(dL * dL + da * da + db * db);
    }

    function accuracyFromDeltaE(deltaE) {
      if (deltaE < 1) return 99.0;
      if (deltaE < 2) return 95.0 - (deltaE - 1) * 5.0;
      if (deltaE < 3.5) return 85.0 - (deltaE - 2.0) * 10.0;
      return Math.max(0.0, 75.0 - deltaE * 5.0);
    }

    function rgbToHex(r, g, b) {
      const toHex = (v) => v.toString(16).padStart(2, "0");
      return "#" + toHex(r) + toHex(g) + toHex(b);
    }

    // -----------------------------
    // 1) 從圖片中心區域抓主色
    // -----------------------------
    function extractDominantColor(img) {
      const canvas = document.getElementById("hiddenCanvas");
      const ctx = canvas.getContext("2d");

      const maxSide = 320;
      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;
      if (!w || !h) return null;

      const scale = Math.min(1, maxSide / Math.max(w, h));
      const targetW = Math.max(1, Math.round(w * scale));
      const targetH = Math.max(1, Math.round(h * scale));

      canvas.width = targetW;
      canvas.height = targetH;
      ctx.drawImage(img, 0, 0, targetW, targetH);

      const centerMargin = 0.2;
      const startX = Math.floor(targetW * centerMargin);
      const endX = Math.ceil(targetW * (1 - centerMargin));
      const startY = Math.floor(targetH * centerMargin);
      const endY = Math.ceil(targetH * (1 - centerMargin));

      const step = 4;
      let rSum = 0,
        gSum = 0,
        bSum = 0,
        count = 0;

      for (let y = startY; y < endY; y += step) {
        for (let x = startX; x < endX; x += step) {
          const pixel = ctx.getImageData(x, y, 1, 1).data;
          const r = pixel[0];
          const g = pixel[1];
          const b = pixel[2];

          const brightness = (r + g + b) / 3;
          if (brightness < 12 || brightness > 245) continue;

          rSum += r;
          gSum += g;
          bSum += b;
          count++;
        }
      }

      if (!count) return null;

      const rAvg = Math.round(rSum / count);
      const gAvg = Math.round(gSum / count);
      const bAvg = Math.round(bSum / count);
      return [rAvg, gAvg, bAvg];
    }

    // -----------------------------
    // 2) 與 PANTONE DB 比對
    // -----------------------------
    function compareWithPantone(rgb) {
      const labIn = rgbToLab(rgb[0], rgb[1], rgb[2]);
      const rows = PANTONE_DB.map((ref) => {
        const labRef = rgbToLab(ref.rgb[0], ref.rgb[1], ref.rgb[2]);
        const de = deltaE76(labIn, labRef);
        const acc = accuracyFromDeltaE(de);
        return {
          name: ref.name,
          rgb: ref.rgb,
          deltaE: de,
          accuracy: acc,
        };
      });

      rows.sort((a, b) => a.deltaE - b.deltaE);
      return rows;
    }

    // -----------------------------
    // 3) UI 綁定與更新
    // -----------------------------
    const fileInput = document.getElementById("fileInput");
    const uploadArea = document.getElementById("uploadArea");
    const previewImage = document.getElementById("previewImage");
    const imagePlaceholder = document.getElementById("imagePlaceholder");
    const swatchBox = document.getElementById("swatchBox");
    const rgbValue = document.getElementById("rgbValue");
    const hexValue = document.getElementById("hexValue");
    const bestNameValue = document.getElementById("bestNameValue");
    const accuracyChip = document.getElementById("accuracyChip");
    const accuracyValue = document.getElementById("accuracyValue");
    const swatchStatus = document.getElementById("swatchStatus");
    const resultsBody = document.getElementById("resultsBody");
    const bestSummary = document.getElementById("bestSummary");
    const statusBar = document.getElementById("statusBar");
    const statusText = document.getElementById("statusText");


    // -----------------------------
    // 色票放大預覽 Modal
    // -----------------------------
    const colorModal = document.getElementById("colorModal");
    const modalSwatch = document.getElementById("modalSwatch");
    const modalPantoneName = document.getElementById("modalPantoneName");
    const modalPantoneMeta = document.getElementById("modalPantoneMeta");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    let lastFocusedEl = null;

    function openColorModal(pantoneName, rgbArr) {
      lastFocusedEl = document.activeElement;
      const hex = rgbToHex(rgbArr[0], rgbArr[1], rgbArr[2]).toUpperCase();
      modalPantoneName.textContent = pantoneName;
      modalPantoneMeta.textContent = `HEX ${hex} · RGB(${rgbArr.join(", ")})`;
      modalSwatch.style.background = hex;

      colorModal.style.display = "flex";
      colorModal.setAttribute("aria-hidden", "false");
      modalCloseBtn.focus();
    }

    function closeColorModal() {
      colorModal.style.display = "none";
      colorModal.setAttribute("aria-hidden", "true");
      if (lastFocusedEl && typeof lastFocusedEl.focus === "function") {
        lastFocusedEl.focus();
      }
      lastFocusedEl = null;
    }

    modalCloseBtn.addEventListener("click", closeColorModal);

    // 點背景關閉（點到 modal 本體不關）
    colorModal.addEventListener("click", (e) => {
      if (e.target === colorModal) closeColorModal();
    });

    // Esc 關閉
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && colorModal.style.display === "flex") {
        closeColorModal();
      }
    });


    // -----------------------------
    // 開始載入 pantonecolors.net 八大色群色票（桌機網路環境）
    // -----------------------------
    pantoneReadyPromise = (async () => {
      try {
        statusText.textContent = "載入 PANTONE 色庫…";
        bestSummary.textContent = "正在載入色庫，第一次可能需要幾秒…";

        const [groupResult, tpgResult] = await Promise.allSettled([
          loadPantoneGroupsFromPantoneColorsNet(),
          loadPantoneTPGFromGithub(),
        ]);

        let addedTotal = 0;

        if (groupResult.status === "fulfilled" && Array.isArray(groupResult.value)) {
          addedTotal += mergePantoneEntries(groupResult.value);
        } else if (groupResult.status === "rejected") {
          console.warn("Pantone group load failed:", groupResult.reason);
        }

        if (tpgResult.status === "fulfilled" && Array.isArray(tpgResult.value)) {
          addedTotal += mergePantoneEntries(tpgResult.value);
        } else if (tpgResult.status === "rejected") {
          console.warn("Pantone TPG load failed:", tpgResult.reason);
        }

        statusText.textContent = `就緒（已載入 ${PANTONE_DB.length} 筆色號，含 C / TPG）`;
        console.log(
          `Pantone DB loaded. Added ${addedTotal}. Total ${PANTONE_DB.length}.`
        );
      } catch (err) {
        statusText.textContent = "就緒（使用內建色庫）";
        console.warn("Pantone palette load failed:", err);
      }
    })();

    uploadArea.addEventListener("click", () => fileInput.click());

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "rgba(56,189,248,0.9)";
    });

    uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "rgba(148,163,184,0.5)";
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "rgba(148,163,184,0.5)";
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });

    function handleFile(file) {
      if (!file.type.startsWith("image/")) {
        alert("請選擇圖片檔案（JPG / PNG）");
        return;
      }
      statusText.textContent = "分析中…";
      bestSummary.textContent = "正在偵測主色並比對 PANTONE…";

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.style.display = "block";
        imagePlaceholder.style.display = "none";

        // 等圖片載入完成再分析
        previewImage.onload = () => {
          setTimeout(runAnalysis, 30);
        };
      };
      reader.readAsDataURL(file);
    }

    async function runAnalysis() {
      await pantoneReadyPromise;
      const rgb = extractDominantColor(previewImage);
      if (!rgb) {
        statusText.textContent = "分析失敗：無法從圖片讀取像素";
        bestSummary.textContent = "無法取得主色，請換一張圖片再試一次。";
        return;
      }

      const [r, g, b] = rgb;
      const hex = rgbToHex(r, g, b);

      swatchBox.style.background = hex;
      rgbValue.textContent = `RGB(${r}, ${g}, ${b})`;
      hexValue.textContent = hex.toUpperCase();
      swatchStatus.textContent = "已完成偵測";

      const rows = compareWithPantone(rgb);
      renderResults(rows, hex);
    }

    const DISPLAY_TOP_N = 10;

    function renderResults(rows, hex) {
      // 填入表格
      resultsBody.innerHTML = "";
      rows.slice(0, DISPLAY_TOP_N).forEach((row, index) => {
        const tr = document.createElement("tr");
        if (index === 0) tr.classList.add("row-best");

        const nameTd = document.createElement("td");
                const swatch = document.createElement("span");
        swatch.className = "pantone-swatch";
        swatch.style.background = rgbToHex(row.rgb[0], row.rgb[1], row.rgb[2]);
        swatch.setAttribute("role", "button");
        swatch.setAttribute("tabindex", "0");
        swatch.setAttribute("aria-label", `預覽 ${row.name} 色塊`);
        swatch.addEventListener("click", () => openColorModal(row.name, row.rgb));
        swatch.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " " ) {
            ev.preventDefault();
            openColorModal(row.name, row.rgb);
          }
        });
        nameTd.appendChild(swatch);

        const spanName = document.createElement("span");
        spanName.className = "pantone-name";
        spanName.textContent = row.name;
        nameTd.appendChild(spanName);

        const chip = document.createElement("span");
        chip.className = "pantone-tag";

        let seriesLabel = "色票";
        const name = row.name || "";
        if (/\bTPG\b/i.test(name)) {
          seriesLabel = "TPG 系列";
        } else if (/\bTCX\b/i.test(name)) {
          seriesLabel = "TCX 系列";
        } else if (/\bC\b/i.test(name)) {
          seriesLabel = "C 系列";
        }

        chip.textContent = seriesLabel;
        nameTd.appendChild(chip);

        const rgbTd = document.createElement("td");
        const rgbBadge = document.createElement("span");
        rgbBadge.className = "rgb-badge";
        rgbBadge.textContent = `RGB(${row.rgb.join(", ")})`;
        rgbTd.appendChild(rgbBadge);

        const deTd = document.createElement("td");
        deTd.className = "delta-e";
        deTd.textContent = row.deltaE.toFixed(2);

        const accTd = document.createElement("td");
        const acc = row.accuracy;
        let accClass = "accuracy-mid";
        if (acc >= 80) accClass = "accuracy-good";
        else if (acc < 40) accClass = "accuracy-low";
        accTd.className = accClass;
        accTd.textContent = acc.toFixed(1) + "%";

        tr.appendChild(nameTd);
        tr.appendChild(rgbTd);
        tr.appendChild(deTd);
        tr.appendChild(accTd);
        resultsBody.appendChild(tr);
      });

      const best = rows[0];
      bestNameValue.textContent = best.name;
      const accStr = best.accuracy.toFixed(1) + "%";
      accuracyValue.textContent = accStr;
      accuracyChip.style.display = "inline-flex";

      bestSummary.textContent = `最接近的 PANTONE 為 ${
        best.name
      }（ΔE = ${best.deltaE.toFixed(2)}，匹配度 = ${accStr}）`;
      statusText.textContent = "完成比對";
    }
  </script>
</body>
</html>

